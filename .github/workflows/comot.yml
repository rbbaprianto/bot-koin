name: Comot koin-bot

on:
  workflow_dispatch:
    inputs:
      SOURCE_URL:
        description: 'Source URL to clone repositories from'
        required: true
        default: 'https://codeberg.org/smart-airdrop'

  schedule:
    - cron: '0 0 * * *'  # Jalan setiap hari jam 00:00 UTC

jobs:
  sync-repos:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y jq git

      - name: Get repo list
        id: get-repos
        run: |
          API_URL="${{ github.event.inputs.SOURCE_URL }}/repos"
          echo "Mengambil daftar repository dari $API_URL"
          RESPONSE=$(curl -s -H "Accept: application/json" "$API_URL")

          if echo "$RESPONSE" | jq empty 2>/dev/null; then
            echo "$RESPONSE" | jq -r '.[].name' > repo_list.txt
            cat repo_list.txt
          else
            echo "Gagal mendapatkan daftar repository dari Codeberg."
            exit 1
          fi

      - name: Clone repositories
        run: |
          mkdir -p repos && cd repos
          for repo in $(cat ../repo_list.txt); do
            echo "Mengunduh repository: $repo"
            git clone --mirror "https://codeberg.org/smart-airdrop/$repo.git" "$repo" || { echo "Gagal cloning $repo"; exit 1; }
          done

      - name: Setup Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: Push to GitHub (Mirror)
        run: |
          cd repos
          for repo in $(cat ../repo_list.txt); do
            echo "Memproses push $repo ke GitHub..."
            cd "$repo"
            git remote set-url origin "git@github.com:rbbaprianto/bot-koin-$repo.git"
            git push --mirror || echo "Gagal push: $repo"
            cd ..
          done

      - name: Commit & Push List
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

          git add README.md
          git commit -m "Update repository list" || echo "No changes to commit"
          
          git push origin main || echo "Gagal push repository"

      - name: Send Telegram Notification
        run: |
          escape_markdown() {
            echo "$1" | sed 's/\([_*\[\]()~`>#\+\-\=\|\{\}\.\!]\)/\\\1/g'
          }

          MESSAGE="ðŸ“Œ *Sinkronisasi Selesai!* \\n\\n"
          MESSAGE+="ðŸ“‚ *Repo Target:* [GitHub](https://github.com/rbbaprianto/bot-koin)\\n"
          MESSAGE+="ðŸ“Œ *Daftar Repository yang disinkronkan:*\\n\`\`\`"

          while IFS= read -r repo; do
            MESSAGE+="\n$repo"
          done < repo_list.txt
          
          MESSAGE+="\`\`\`"

          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
            -d "chat_id=${{ secrets.TELEGRAM_CHAT_ID }}" \
            -d "text=${MESSAGE}" \
            -d "parse_mode=MarkdownV2"
