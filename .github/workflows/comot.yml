name: Comot

on:
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      SOURCE_URL:
        description: 'Source URL to clone repositories from'
        required: true
        default: 'https://codeberg.org/smart-airdrop'

  schedule:
    - cron: '0 0 * * *'  # Jalan setiap hari jam 00:00 UTC

jobs:
  sync-repos:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install dependencies
        run: sudo apt update && sudo apt install -y jq git

      - name: Get repository list from source
        run: |
          API_URL="https://codeberg.org/api/v1/users/smart-airdrop/repos"
          echo "Fetching repository list from $API_URL..."
          response=$(curl -s -H "Accept: application/json" "$API_URL")
      
          # Cek apakah response valid JSON
          if echo "$response" | jq empty 2>/dev/null; then
            repos=$(echo "$response" | jq -r '.[].name')
            echo "$repos" > repo_list.txt
            echo "REPO_LIST=$repos" >> $GITHUB_ENV
          else
            echo "Error: Response is not a valid JSON"
            echo "Response: $response"
            exit 1
          fi

      - name: Clone repositories
        run: |
          mkdir repos && cd repos
          for repo in $(cat ../repo_list.txt); do
            git clone "${{ github.event.inputs.SOURCE_URL }}/$repo.git" "$repo"
          done

      - name: Clean repositories (Remove .git and hidden files)
        run: |
          cd repos
          for repo in *; do
            echo "Cleaning repository: $repo"
            rm -rf "$repo/.git" "$repo/.github" "$repo/.gitignore"
            # find "$repo" -type f -name "README.md" -delete  # (Opsional) Hapus README asal
          done

      - name: Push repositories to GitHub
        run: |
          cd repos
          for repo in *; do
            cd "$repo"
            git init
            git add .
            git commit -m "Initial commit from ${{ github.event.inputs.SOURCE_URL }}/$repo"
            git branch -M main
            git remote add origin "https://${{ secrets.GITHUB_PAT }}@github.com/${{ secrets.TARGET_GITHUB_REPO }}/$repo.git"
            git push -u origin main --force
            cd ..
          done

      - name: Generate README.md
        run: |
          echo "# List of Repositories" > README.md
          echo "" >> README.md
          for repo in $(cat repo_list.txt); do
            echo "- [$repo](https://github.com/${{ secrets.TARGET_GITHUB_REPO }}/$repo)" >> README.md
          done

      - name: Commit and push README update
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add README.md
          git commit -m "Update README with new repo list" || echo "No changes to commit"
          git push origin main

      - name: Send Telegram Notification
        run: |
          MESSAGE="âœ… *Repository Sync Completed!*\n\n*Source:* ${{ github.event.inputs.SOURCE_URL }}\n*Target:* ${{ secrets.TARGET_GITHUB_REPO }}\n\n*List of Repositories:*\n"
          for repo in $(cat repo_list.txt); do
            MESSAGE+="\n- $repo"
          done
          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
            -d "chat_id=${{ secrets.TELEGRAM_CHAT_ID }}" \
            -d "chat_id=144"
            -d "text=$MESSAGE" \
            -d "parse_mode=Markdown"
