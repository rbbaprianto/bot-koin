name: Comot koin-bot

on:
  workflow_dispatch:
    inputs:
      SOURCE_URL:
        description: 'Source URL to clone repositories from'
        required: true

jobs:
  sync-repos:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Install dependencies
        run: sudo apt update && sudo apt install -y jq git

      - name: Get repository list from source
        run: |
          API_URL="https://codeberg.org/api/v1/users/smart-airdrop/repos"
          RESPONSE=$(curl -s -H "Accept: application/json" "$API_URL")

          if echo "$RESPONSE" | jq empty 2>/dev/null; then
            repos=$(echo "$RESPONSE" | jq -r '.[].name')
            echo "$repos" > repo_list.txt
            echo "REPO_LIST=$(echo "$repos" | tr '\n' ' ')" >> $GITHUB_ENV
          else
            echo "Error: Invalid JSON response"
            echo "Response: $RESPONSE"
            exit 1
          fi

      - name: Clone all repositories
        run: |
          mkdir -p repos
          cd repos
          for repo in $REPO_LIST; do
            echo "Cloning $repo..."
            git clone --mirror "https://codeberg.org/smart-airdrop/$repo.git" "$repo" || echo "Failed to clone $repo"
          done

      - name: Push to GitHub (Mirror)
        run: |
          cd repos
          for repo in *; do
            cd "$repo"
            git remote set-url --push origin "git@github.com:rbbaprianto/bot-koin.git"
            git push --mirror
            cd ..
          done

      - name: Generate README.md
        run: |
          echo "# List of Repositories" > README.md
          echo "" >> README.md
          for repo in $REPO_LIST; do
            echo "- [$repo](https://github.com/rbbaprianto/bot-koin/tree/main/repos/$repo)" >> README.md
          done

      - name: Push README.md
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          git add README.md
          git commit -m "Update README with new repo list" || echo "No new changes"
          git push origin main

      - name: Send Telegram Notification
        run: |
          escape_markdown() {
            echo "$1" | sed -e 's/[\_\*\[\]\(\)\~\`\>\#\+\-\=\|\{\}\.\!]/\\&/g'
          }
  
          SOURCE_URL="${{ github.event.inputs.SOURCE_URL }}"
  
          MESSAGE="âœ… *Repository Sync Completed\!*\\n\\n"
          MESSAGE+="ðŸ“Œ *Source:* [$(escape_markdown "$SOURCE_URL")]($SOURCE_URL)\\n"
          MESSAGE+="ðŸ“‚ *Target:* [GitHub](https://github.com/rbbaprianto/bot-koin)\\n\\n"
          MESSAGE+="ðŸ“œ *List of Repositories:*\\n\`\`\`"
  
          while IFS= read -r repo; do
            ESCAPED_REPO=$(escape_markdown "$repo")
            MESSAGE+="$ESCAPED_REPO\\n"
          done < repo_list.txt
  
          MESSAGE+="\`\`\`"
  
          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
            -d "chat_id=${{ secrets.TELEGRAM_CHAT_ID }}" \
            -d "message_thread_id=144" \
            -d "text=${MESSAGE}" \
            -d "parse_mode=MarkdownV2"
